<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Project</title>
    <link rel="stylesheet" href="src/css/bootstrap.css" />
    <link rel="stylesheet" href="src/css/font-awesome.min.css" />
    <link rel="stylesheet" href="src/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="src/jquery.min.js"></script>
    <script src="src/bootstrap.min.js"></script>
    <script src="src/leaflet.js"></script>
    <script src="src/canvas.js"></script>
  </head>

  <body>
    <div id="header" class="col-md-12">
      <h1 class="text-center">
        Poverty
      </h1>
    </div>
    <div id="side_panel" class="col-md-3">
      <h1 class="text-center">Categories</h1>
      <div class="dropdown attraction">
        <button
          id="education"
          class="form-control btn btn-warning dropdown-toggle"
          type="button"
          data-toggle="dropdown"
        >
          Education <span class="caret"></span>
        </button>
        <ul class="dropdown-menu down">
          <li><a id="btn1">SSC</a></li>
          <li><a id="btn2">Intermediate</a></li>
          <li><a id="btn3">Graduation</a></li>
          <li><a id="btn4">Post Graduation</a></li>
          <li><a id="btn5">Others</a></li>
        </ul>
      </div>
      <div class="dropdown attraction">
        <button
          id="area"
          class="form-control btn btn-warning dropdown-toggle"
          type="button"
          data-toggle="dropdown"
        >
          Area <span class="caret"></span>
        </button>
        <ul class="dropdown-menu down">
          <li><a id="btn6">Rural</a></li>
          <li><a id="btn7">Urban</a></li>
        </ul>
      </div>
    </div>
    <div id="main_panel" class="col-md-9"></div>
    <div
      id="chartContainer"
      class="col-md-12 chart"
      style="height: 300px; width: 100%;"
    ></div>
    <script>
      var mymap = L.map("main_panel").setView([16.9874509, 81.7363171], 13);
      var backgroundLayer = L.tileLayer(
        "http://{s}.tile.osm.org/{z}/{x}/{y}.png"
      );
      mymap.addLayer(backgroundLayer);

      var layerAttractions;
      var refInterval = window.setInterval('update()', 30000); // 30 seconds

      //   setInterval(function() {
      $.ajax({
        url: "load_data.php",
        dataType: "json",
        success: function(response) {
          if (layerAttractions) {
            layerAttractions.remove();
          }
          //   setInterval(function() {
          layerAttractions = L.geoJSON(response, {
            pointToLayer: function(feature, latlng) {
              var str =
                "<h4>" +
                feature.properties.name +
                "</h4><hr><a href='" +
                feature.properties.web +
                "' target='blank'><img src='img/" +
                feature.properties.image +
                "' width='200px'></a>";
              return L.marker(latlng).bindPopup(str);
            }
          });
          //   }, 1000);
          layerAttractions.addTo(mymap);
          mymap.fitBounds(layerAttractions.getBounds());

          $("#education").on("click", function() {
            var ssc = 0;
            var inter = 0;
            var graduation = 0;
            var post = 0;
            var others = 0;
            if (layerAttractions) {
              layerAttractions.remove();
            }
            // setInterval(function() {
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.education == "SSC") {
                  ssc += 1;
                } else if (feature.properties.education == "Intermediate") {
                  inter += 1;
                } else if (feature.properties.education == "Graduation") {
                  graduation += 1;
                } else if (feature.properties.education == "Post Graduation") {
                  post += 1;
                } else {
                  others += 1;
                }
                return L.marker(latlng);
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
            // }, 1000);
            var chart = new CanvasJS.Chart("chartContainer", {
              theme: "light2",
              title: {
                text: "Education Levels"
              },
              data: [
                {
                  type: "pie",
                  showInLegend: true,
                  //   toolTipContent: "{y} - #percent %",
                  toolTipContent: "#percent %",
                  legendText: "{indexLabel}",
                  dataPoints: [
                    {
                      y: ssc,
                      indexLabel: "SSC"
                    },
                    {
                      y: inter,
                      indexLabel: "Intermediate"
                    },
                    {
                      y: graduation,
                      indexLabel: "Graduation"
                    },
                    {
                      y: post,
                      indexLabel: "Post Graduation"
                    },
                    {
                      y: others,
                      indexLabel: "Others"
                    }
                  ]
                }
              ]
            });
            chart.render();
          });

          $("#area").on("click", function() {
            var rural = 0;
            var urban = 0;
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.area == "Rural") {
                  rural += 1;
                } else if (feature.properties.area == "Urban") {
                  urban += 1;
                }
                return L.marker(latlng);
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());

            var chart = new CanvasJS.Chart("chartContainer", {
              theme: "light2",
              title: {
                text: "Area Type"
              },
              data: [
                {
                  type: "pie",
                  showInLegend: true,
                  //   toolTipContent: "{y} - #percent %",
                  toolTipContent: "#percent %",
                  legendText: "{indexLabel}",
                  dataPoints: [
                    {
                      y: rural,
                      indexLabel: "Rural"
                    },
                    {
                      y: urban,
                      indexLabel: "Urban"
                    }
                  ]
                }
              ]
            });
            chart.render();
          });

          $("#btn1").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.education == $("#btn1").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn2").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.education == $("#btn2").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn3").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.education == $("#btn3").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn4").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.education == $("#btn4").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn5").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (
                  feature.properties.education != $("#btn1").text() &&
                  feature.properties.education != $("#btn2").text() &&
                  feature.properties.education != $("#btn3").text() &&
                  feature.properties.education != $("#btn4").text()
                ) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn6").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.area == $("#btn6").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
          $("#btn7").on("click", function() {
            if (layerAttractions) {
              layerAttractions.remove();
            }
            layerAttractions = L.geoJSON(response, {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.area == $("#btn7").text()) {
                  return L.marker(latlng);
                }
              }
            });
            layerAttractions.addTo(mymap);
            mymap.fitBounds(layerAttractions.getBounds());
          });
        }
      });
      //   }, 1000);
    </script>
  </body>
</html>
