<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Project</title>
    <link rel="stylesheet" href="src/css/bootstrap.min.css" />
    <link rel="stylesheet" href="src/css/font-awesome.css" />
    <link rel="stylesheet" href="src/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css" />
    <link rel="stylesheet" href="src/plugins/easy-button.css" />
    <link rel="stylesheet" href="src/plugins/Leaflet.PolylineMeasure.css" />
    <link rel="stylesheet" href="src/plugins/leaflet.awesome-markers.css" />
    <script src="src/jquery.min.js"></script>
    <script src="src/js/bootstrap.min.js"></script>
    <script src="src/leaflet.js"></script>
    <script src="src/canvas.js"></script>
    <script src="src/plugins/L.Control.Sidebar.js"></script>
    <script src="src/plugins/leaflet.spin.min.js"></script>
    <script src="src/plugins/spin.min.js"></script>
    <script src="src/plugins/easy-button.js"></script>
    <script src="src/plugins/bouncemarker.js"></script>
    <script src="src/plugins/Leaflet.PolylineMeasure.js"></script>
    <script src="src/plugins/leaflet.awesome-markers.min.js"></script>
  </head>

  <body>
    <!-- <div id="header" class="col-md-12">
      <h1 class="text-center">
        Poverty
      </h1>
    </div> -->
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Poverty</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- <li class="active">
              <a href="#">Link <span class="sr-only">(current)</span></a>
            </li> -->
            <li><a href="#">Link</a></li>
            <!-- <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >Dropdown <span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">Separated link</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li> -->
          </ul>
          <!-- <form class="navbar-form navbar-left">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search" />
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form> -->
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">About Us</a></li>
            <!-- <li class="dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                role="button"
                aria-haspopup="true"
                aria-expanded="false"
                >Dropdown <span class="caret"></span
              ></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li role="separator" class="divider"></li>
                <li><a href="#">Separated link</a></li>
              </ul>
            </li> -->
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
    </nav>
    <div id="side_panel">
      <h2 class="text-center">Categories</h2>
      <div class="dropdown attraction">
        <button
          id="education"
          class="form-control btn btn-warning dropdown-toggle"
          type="button"
          data-toggle="dropdown"
        >
          Education<span class="caret"></span>
        </button>
        <ul class="dropdown-menu down">
          <li><a id="btn1">SSC</a></li>
          <li><a id="btn2">Intermediate</a></li>
          <li><a id="btn3">Graduation</a></li>
          <li><a id="btn4">Post Graduation</a></li>
          <li><a id="btn5">Others</a></li>
        </ul>
      </div>
      <div class="dropdown attraction">
        <button
          id="area"
          class="form-control btn btn-warning dropdown-toggle"
          type="button"
          data-toggle="dropdown"
        >
          Area<span class="caret"></span>
        </button>
        <ul class="dropdown-menu down">
          <li><a id="btn6">Rural</a></li>
          <li><a id="btn7">Urban</a></li>
        </ul>
      </div>
      <div class="dropdown attraction">
        <button
          id="caste"
          class="form-control btn btn-warning dropdown-toggle"
          type="button"
          data-toggle="dropdown"
        >
          Caste<span class="caret"></span>
        </button>
        <ul class="dropdown-menu down">
          <li><a id="btn8">OC</a></li>
          <li><a id="btn9">BC</a></li>
          <li><a id="btn10">SC</a></li>
        </ul>
      </div>
    </div>
    <div id="main_panel" class="col-md-12"></div>
    <div id="details_panel"></div>
    <div id="chartContainer" class="col-md-12 chart"></div>
    <div id="table_panel"></div>

    <script>
      var mymap = L.map("main_panel", {
        center: [16.9874509, 81.7363171],
        zoom: 11,
        zoomControl: false,
        attributionControl: false
      });

      mymap.spin(true);

      var backgroundLayer = L.tileLayer(
        // "http://{s}.tile.osm.org/{z}/{x}/{y}.png"
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      );
      mymap.addLayer(backgroundLayer);

      backgroundLayer.on("loading", function() {
        mymap.spin(true);
      });
      backgroundLayer.on("load", function() {
        mymap.spin(false);
      });

      var sidebar = L.control.sidebar("side_panel", {
        position: "left",
        closeButton: false,
        autoPan: false
      });
      mymap.addControl(sidebar);

      var ctlSidebar = L.easyButton({
        states: [
          {
            stateName: "open-menu",
            icon: "fa fa-bars",
            title: "Open Menu",
            onClick: function() {
              sidebar.show();
              this.state("close-menu");
            }
          },
          {
            stateName: "close-menu",
            icon: "fa fa-bars",
            title: "Close Menu",
            onClick: function() {
              sidebar.hide();
              this.state("open-menu");
            }
          }
        ]
      });
      ctlSidebar.addTo(mymap);

      var detailsbar = L.control.sidebar("details_panel", {
        position: "right",
        // closeButton: false,
        autoPan: false
      });
      mymap.addControl(detailsbar);

      L.control
        .polylineMeasure({
          position: "topleft",
          unit: "metres"
        })
        .addTo(mymap);

      var layerAttractions;
      var data;
      var props;

      setInterval(function() {
        $.ajax({
          url: "load_data.php",
          dataType: "json",
          success: function(response) {
            if (JSON.stringify(response) !== JSON.stringify(data)) {
              if (layerAttractions) {
                layerAttractions.remove();
              }
              var redMarker = L.AwesomeMarkers.icon({
                icon: "map-pin",
                prefix: "fa",
                markerColor: "green ",
                iconColor: "blue"
              });
              // var redMarker = L.icon({
              //   iconUrl: "pin.png",
              //   // iconRetinaUrl: "my-icon@2x.png",
              //   iconSize: [20, 20],
              //   iconAnchor: [22, 94],
              //   popupAnchor: [-3, -76],
              //   shadowUrl: "my-icon-shadow.png",
              //   shadowRetinaUrl: "my-icon-shadow@2x.png",
              //   shadowSize: [68, 95],
              //   shadowAnchor: [22, 94]
              // });
              layerAttractions = L.geoJSON(response, {
                pointToLayer: function(feature, latlng) {
                  return L.marker(latlng, {
                    bounceOnAdd: true,
                    icon: redMarker
                  });
                },
                onEachFeature: function(feature, layerAttractions) {
                  layerAttractions.on("click", displayData);
                }
              });
              layerAttractions.addTo(mymap);
              mymap.fitBounds(layerAttractions.getBounds());

              $("#education").on("click", function() {
                var ssc = 0;
                var inter = 0;
                var graduation = 0;
                var post = 0;
                var others = 0;
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.education == "SSC") {
                      ssc += 1;
                    } else if (feature.properties.education == "Intermediate") {
                      inter += 1;
                    } else if (feature.properties.education == "Graduation") {
                      graduation += 1;
                    } else if (
                      feature.properties.education == "Post Graduation"
                    ) {
                      post += 1;
                    } else {
                      others += 1;
                    }
                    return L.marker(latlng);
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());

                var chart = new CanvasJS.Chart("chartContainer", {
                  theme: "light2",
                  title: {
                    text: "Education Levels"
                  },
                  data: [
                    {
                      type: "pie",
                      showInLegend: true,
                      //   toolTipContent: "{y} - #percent %",
                      toolTipContent: "#percent %",
                      legendText: "{indexLabel}",
                      dataPoints: [
                        {
                          y: ssc,
                          indexLabel: "SSC"
                        },
                        {
                          y: inter,
                          indexLabel: "Intermediate"
                        },
                        {
                          y: graduation,
                          indexLabel: "Graduation"
                        },
                        {
                          y: post,
                          indexLabel: "Post Graduation"
                        },
                        {
                          y: others,
                          indexLabel: "Others"
                        }
                      ]
                    }
                  ]
                });
                chart.render();
              });

              $("#area").on("click", function() {
                var rural = 0;
                var urban = 0;
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.area == "Rural") {
                      rural += 1;
                    } else if (feature.properties.area == "Urban") {
                      urban += 1;
                    }
                    return L.marker(latlng);
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());

                var chart = new CanvasJS.Chart("chartContainer", {
                  theme: "light2",
                  title: {
                    text: "Area Type"
                  },
                  data: [
                    {
                      type: "pie",
                      showInLegend: true,
                      //   toolTipContent: "{y} - #percent %",
                      toolTipContent: "#percent %",
                      legendText: "{indexLabel}",
                      dataPoints: [
                        {
                          y: rural,
                          indexLabel: "Rural"
                        },
                        {
                          y: urban,
                          indexLabel: "Urban"
                        }
                      ]
                    }
                  ]
                });
                chart.render();
              });

              $("#caste").on("click", function() {
                var oc = 0;
                var bc = 0;
                var sc = 0;
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.caste == "OC") {
                      oc += 1;
                    } else if (feature.properties.caste == "BC") {
                      bc += 1;
                    } else if (feature.properties.caste == "SC") {
                      sc += 1;
                    }
                    return L.marker(latlng);
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());

                var chart = new CanvasJS.Chart("chartContainer", {
                  theme: "light2",
                  title: {
                    text: "Caste"
                  },
                  data: [
                    {
                      type: "pie",
                      showInLegend: true,
                      //   toolTipContent: "{y} - #percent %",
                      toolTipContent: "#percent %",
                      legendText: "{indexLabel}",
                      dataPoints: [
                        {
                          y: oc,
                          indexLabel: "OC"
                        },
                        {
                          y: bc,
                          indexLabel: "BC"
                        },
                        {
                          y: sc,
                          indexLabel: "SC"
                        }
                      ]
                    }
                  ]
                });
                chart.render();
              });

              $("#btn1").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.education == $("#btn1").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn2").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.education == $("#btn2").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn3").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.education == $("#btn3").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn4").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.education == $("#btn4").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn5").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (
                      feature.properties.education != $("#btn1").text() &&
                      feature.properties.education != $("#btn2").text() &&
                      feature.properties.education != $("#btn3").text() &&
                      feature.properties.education != $("#btn4").text()
                    ) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn6").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.area == $("#btn6").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn7").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.area == $("#btn7").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn8").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.caste == $("#btn8").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn9").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.caste == $("#btn9").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              $("#btn10").on("click", function() {
                if (layerAttractions) {
                  layerAttractions.remove();
                }
                layerAttractions = L.geoJSON(response, {
                  pointToLayer: function(feature, latlng) {
                    if (feature.properties.caste == $("#btn10").text()) {
                      return L.marker(latlng);
                    }
                  },
                  onEachFeature: function(feature, layerAttractions) {
                    layerAttractions.on("click", displayData);
                  }
                });
                sidebar.hide();
                layerAttractions.addTo(mymap);
                mymap.fitBounds(layerAttractions.getBounds());
              });

              data = response;
            }

            $("#table_data").on("click", function() {
              detailsbar.hide();
              $("html,body").animate(
                {
                  scrollTop: $("#table_data").offset().top
                },
                "slow"
              );
              var val = $("#table_data").val();
              var tableData = "";
              tableData += "<table class='table table-striped'>";
              tableData += "<tr>";
              tableData += "<th>ID</th>";
              tableData += "<th>Education</th>";
              tableData += "<th>Area</th>";
              tableData += "<th>Electricity</th>";
              tableData += "</tr>";
              for (i = 0; i < response.features.length; i++) {
                if (response.features[i].properties.id == val) {
                  props = response.features[i].properties;
                  tableData += "<tr>";
                  tableData += "<td>" + props.id + "</td>";
                  tableData += "<td>" + props.education + "</td>";
                  tableData += "<td>" + props.area + "</td>";
                  tableData += "<td>" + props.electricity_connection + "</td>";
                  tableData += "</tr>";
                  tableData += "</table>";
                  break;
                }
                // });
              }
              $("#table_panel")
                .empty()
                .append(tableData);
              // }
              // console.log(detailsbar.isVisible());
            });
          }
        });
      }, 1000);

      function displayData(e) {
        $("#details_panel")
          .empty()
          .append(
            "<h3>Location Details</h3>" +
              "<p class='data_class'>ID : " +
              e.target.feature.properties.id +
              "</p>" +
              "<p class='data_class'>Area : " +
              e.target.feature.properties.area +
              "</p>" +
              "<p class='data_class'>Caste : " +
              e.target.feature.properties.caste +
              "</p>" +
              "<p class='data_class'>Education : " +
              e.target.feature.properties.education +
              "</p>" +
              "<p class='data_class'>Electricity Status: " +
              e.target.feature.properties.electricity_connection +
              "</p>" +
              "<p class='data_class'>Latitude : " +
              e.latlng.lat +
              "</p>" +
              "<p class='data_class'>Longitude : " +
              e.latlng.lng +
              "</p>" +
              "<button id='table_data' class='btn btn-warning' value='" +
              e.target.feature.properties.id +
              "'>More Details</button>"
          );
        detailsbar.show();
      }
    </script>
  </body>
</html>
